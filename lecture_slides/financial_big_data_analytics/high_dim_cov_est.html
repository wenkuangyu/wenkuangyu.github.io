<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="zh-Hans" xml:lang="zh-Hans"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.40">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="文旷宇">

<title>高维协方差矩阵估计方法</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="high_dim_cov_est_files/libs/clipboard/clipboard.min.js"></script>
<script src="high_dim_cov_est_files/libs/quarto-html/quarto.js"></script>
<script src="high_dim_cov_est_files/libs/quarto-html/popper.min.js"></script>
<script src="high_dim_cov_est_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="high_dim_cov_est_files/libs/quarto-html/anchor.min.js"></script>
<link href="high_dim_cov_est_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="high_dim_cov_est_files/libs/quarto-html/quarto-syntax-highlighting-549806ee2085284f45b00abea8c6df48.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="high_dim_cov_est_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="high_dim_cov_est_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="high_dim_cov_est_files/libs/bootstrap/bootstrap-6021346ce6ec68ee34ae0f02a7acaa68.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body>

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">目录</h2>
   
  <ul class="collapse">
  <li><a href="#概述" id="toc-概述" class="nav-link active" data-scroll-target="#概述"><span class="header-section-number">1</span> 概述</a></li>
  <li><a href="#高维协方差矩阵的稀疏结构假设与相关估计方法" id="toc-高维协方差矩阵的稀疏结构假设与相关估计方法" class="nav-link" data-scroll-target="#高维协方差矩阵的稀疏结构假设与相关估计方法"><span class="header-section-number">2</span> 高维协方差矩阵的稀疏结构假设与相关估计方法</a>
  <ul class="collapse">
  <li><a href="#带化矩阵假设下的估计方法" id="toc-带化矩阵假设下的估计方法" class="nav-link" data-scroll-target="#带化矩阵假设下的估计方法"><span class="header-section-number">2.1</span> 带化矩阵假设下的估计方法</a></li>
  <li><a href="#稀疏性假设下的阈值估计方法及其拓展" id="toc-稀疏性假设下的阈值估计方法及其拓展" class="nav-link" data-scroll-target="#稀疏性假设下的阈值估计方法及其拓展"><span class="header-section-number">2.2</span> 稀疏性假设下的阈值估计方法及其拓展</a></li>
  </ul></li>
  <li><a href="#无稀疏结构下的压缩估计" id="toc-无稀疏结构下的压缩估计" class="nav-link" data-scroll-target="#无稀疏结构下的压缩估计"><span class="header-section-number">3</span> 无稀疏结构下的压缩估计</a>
  <ul class="collapse">
  <li><a href="#线性压缩估计" id="toc-线性压缩估计" class="nav-link" data-scroll-target="#线性压缩估计"><span class="header-section-number">3.1</span> 线性压缩估计</a></li>
  <li><a href="#非线性压缩估计" id="toc-非线性压缩估计" class="nav-link" data-scroll-target="#非线性压缩估计"><span class="header-section-number">3.2</span> 非线性压缩估计</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">高维协方差矩阵估计方法</h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">作者</div>
    <div class="quarto-title-meta-contents">
             <p>文旷宇 </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<div class="cell">
<style type="text/css">
p {
  text-indent: 2em;
  margin-bottom: 0.5;
  margin-top: 0.5;
}
</style>
</div>
<style>
/* 设置正文文字为宋体 */
body {
    font-family: "SimSun", serif;
}

/* 设置标题（h1, h2, h3 等）为楷体加黑 */
h1, h2, h3, h4, h5, h6 {
    font-family: "KaiTi", serif;
    font-weight: bold;
}
</style>
<section id="概述" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> 概述</h1>
<p>协方差矩阵估计是统计学和金融学中的核心课题之一，主要用于刻画多维随机变量之间的线性依赖关系。这一方法在风险管理、投资组合优化以及资产定价等领域具有广泛的应用价值。设<span class="math inline">\(p\)</span>维随机向量<span class="math inline">\(\mathbf X=(X_1,\cdots,X_p)^T\)</span>，其协方差矩阵<span class="math inline">\(\Sigma\)</span>是一个<span class="math inline">\(p\times p\)</span>的对称矩阵，其第<span class="math inline">\((i,j)\)</span>元素定义为： <span class="math display">\[
\Sigma_{ij} = \text{Cov}(X_i, X_j)
\]</span> 其中<span class="math inline">\(\text{Cov}(X_i, X_j)\)</span>表示<span class="math inline">\(X_i\)</span>和<span class="math inline">\(X_j\)</span>之间的协方差，而对角线元素<span class="math inline">\(\Sigma_{ii}\)</span>则代表变量<span class="math inline">\(X_i\)</span>的方差。</p>
<p>在Markowitz投资组合优化模型（又称均值-方差优化模型）中，协方差矩阵扮演着关键角色，用于量化资产之间的风险和相关关系。该模型通过在给定收益水平下最小化投资组合风险来构建有效前沿。假设<span class="math inline">\(\mathbf X\)</span>表示<span class="math inline">\(p\)</span>个风险资产的收益率，其预期收益和协方差矩阵分别为<span class="math inline">\(\boldsymbol \mu\)</span>和<span class="math inline">\(\Sigma\)</span>。记投资组合权重为<span class="math inline">\(\mathbf w\)</span>，则该优化问题可表述为： <span class="math display">\[
\min_w w^T \Sigma w \quad \text{s.t.} \quad w^T \mu \ge \mu_p, \quad w^T \mathbf{1} = 1
\]</span> 其中<span class="math inline">\(\mu_p\)</span>为目标投资组合收益率，<span class="math inline">\(\mathbf{1}\)</span>为全1向量。协方差矩阵的准确性直接影响资产间的风险分散效果，从而决定最优权重<span class="math inline">\(w\)</span>的选择。通常，预期收益率向量<span class="math inline">\(\boldsymbol \mu\)</span>和协方差矩阵<span class="math inline">\(\Sigma\)</span>需要基于历史收益率数据进行估计。</p>
<p>假设我们观测到独立同分布样本<span class="math inline">\(\mathbf X_1, \mathbf X_2,\cdots,\mathbf X_n\)</span>，则样本协方差矩阵 <span id="eq-samplecov"><span class="math display">\[
S = \frac{1}{n}\sum_{t=1}^n (\mathbf X_t-\bar{\mathbf X}) (\mathbf X_t-\bar{\mathbf X})^T
\tag{1}\]</span></span> 是协方差矩阵<span class="math inline">\(\Sigma\)</span>的一个估计量，其中<span class="math inline">\(\bar{\mathbf X}=n^{-1}\sum_{t=1}^n \mathbf X_t\)</span>为样本均值向量。在低维情形下（即<span class="math inline">\(n \gg p\)</span>），样本协方差矩阵具有良好的性质：它可逆、一致，且具有渐近正态性，即<span class="math inline">\(\sqrt{n}(\text{vec}(S) - \text{vec}(\Sigma))\)</span>依分布收敛于正态分布。此外，样本协方差矩阵<span class="math inline">\(S\)</span>的特征值会收敛于总体协方差矩阵<span class="math inline">\(\Sigma\)</span>的特征值。具体而言，若<span class="math inline">\(\lambda^*_1 \geq \lambda^*_2 \geq \dots \geq \lambda^*_p\)</span>为<span class="math inline">\(\Sigma\)</span>的特征值，<span class="math inline">\(\lambda_1 \geq \lambda_2 \geq \dots \geq \lambda_p\)</span>为<span class="math inline">\(S\)</span>的特征值，则有： <span class="math display">\[
            \lambda_i \overset{P}{\to} \lambda^*_i \quad \text{当} \quad n \to \infty.
\]</span> 然而，在高维情形下（即维度<span class="math inline">\(p\)</span>与样本量<span class="math inline">\(n\)</span>相当或更大，<span class="math inline">\(p \gg n\)</span>），样本协方差矩阵的估计会面临一系列挑战，导致其失效。当<span class="math inline">\(p &gt; n\)</span>时，样本协方差矩阵<span class="math inline">\(S\)</span>将变为奇异矩阵，且其估计偏差和方差显著增大。此外，样本协方差矩阵<span class="math inline">\(S\)</span>的特征值与总体协方差矩阵<span class="math inline">\(\Sigma\)</span>的特征值之间会出现显著偏差，样本特征值分布也会偏离真实分布。通常，总体协方差矩阵<span class="math inline">\(\Sigma\)</span>的最大特征值会被高估，而最小特征值则会被低估。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 高维情形下样本协方差矩阵失效的R代码示例</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 加载必要的库</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置随机种子以确保结果可重复</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 参数设置</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">100</span>  <span class="co"># 维度</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span>   <span class="co"># 样本量</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成真实协方差矩阵（假设为对角矩阵）</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>Sigma_true <span class="ot">&lt;-</span> <span class="fu">diag</span>(p)</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成多元正态分布数据</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(n, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, p), <span class="at">Sigma =</span> Sigma_true)</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算样本协方差矩阵</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>Sigma_sample <span class="ot">&lt;-</span> <span class="fu">cov</span>(X)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="co"># 检查样本协方差矩阵的奇异性</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">rankMatrix</span>(Sigma_sample) <span class="sc">&lt;</span> p) {</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"样本协方差矩阵是奇异的（不可逆）。</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"样本协方差矩阵是非奇异的（可逆）。</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>样本协方差矩阵是奇异的（不可逆）。</code></pre>
</div>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较真实协方差矩阵和样本协方差矩阵的特征值</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>eigen_true <span class="ot">&lt;-</span> <span class="fu">eigen</span>(Sigma_true)<span class="sc">$</span>values</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>eigen_sample <span class="ot">&lt;-</span> <span class="fu">eigen</span>(Sigma_sample)<span class="sc">$</span>values</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 绘制特征值对比图</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(eigen_true, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"blue"</span>, <span class="at">ylim =</span> <span class="fu">range</span>(<span class="fu">c</span>(eigen_true, eigen_sample)),</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">"特征值索引"</span>, <span class="at">ylab =</span> <span class="st">"特征值"</span>, <span class="at">main =</span> <span class="st">"真实与样本协方差矩阵的特征值对比"</span>)</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="fu">lines</span>(eigen_sample, <span class="at">type =</span> <span class="st">"b"</span>, <span class="at">col =</span> <span class="st">"red"</span>)</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="fu">legend</span>(<span class="st">"topright"</span>, <span class="at">legend =</span> <span class="fu">c</span>(<span class="st">"真实特征值"</span>, <span class="st">"样本特征值"</span>), <span class="at">col =</span> <span class="fu">c</span>(<span class="st">"blue"</span>, <span class="st">"red"</span>), <span class="at">lty =</span> <span class="dv">1</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-2-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算条件数</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>condition_number_true <span class="ot">&lt;-</span> <span class="fu">max</span>(eigen_true) <span class="sc">/</span> <span class="fu">min</span>(eigen_true)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>condition_number_sample <span class="ot">&lt;-</span> <span class="fu">abs</span>(<span class="fu">max</span>(eigen_sample) <span class="sc">/</span> <span class="fu">min</span>(eigen_sample))</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"真实协方差矩阵的条件数:"</span>, condition_number_true, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>真实协方差矩阵的条件数: 1 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"样本协方差矩阵的条件数:"</span>, condition_number_sample, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>样本协方差矩阵的条件数: 3.810329e+15 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 检查样本协方差矩阵的条件数是否显著增大</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (condition_number_sample <span class="sc">&gt;</span> <span class="dv">10</span> <span class="sc">*</span> condition_number_true) {</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"样本协方差矩阵的条件数显著增大，表明估计不稳定。</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>} <span class="cf">else</span> {</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">cat</span>(<span class="st">"样本协方差矩阵的条件数相对稳定。</span><span class="sc">\n</span><span class="st">"</span>)</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>样本协方差矩阵的条件数显著增大，表明估计不稳定。</code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出真实和样本协方差矩阵的前5行和前5列</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"真实协方差矩阵（前5x5）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>真实协方差矩阵（前5x5）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Sigma_true[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>     [,1] [,2] [,3] [,4] [,5]
[1,]    1    0    0    0    0
[2,]    0    1    0    0    0
[3,]    0    0    1    0    0
[4,]    0    0    0    1    0
[5,]    0    0    0    0    1</code></pre>
</div>
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"样本协方差矩阵（前5x5）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>样本协方差矩阵（前5x5）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Sigma_sample[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             [,1]         [,2]         [,3]         [,4]        [,5]
[1,]  1.525719367  0.007196938 -0.116373354  0.060185045 0.288532327
[2,]  0.007196938  0.969917411 -0.009698882 -0.001109417 0.174393596
[3,] -0.116373354 -0.009698882  1.179549189 -0.149925659 0.039293879
[4,]  0.060185045 -0.001109417 -0.149925659  0.613148899 0.001869769
[5,]  0.288532327  0.174393596  0.039293879  0.001869769 0.924993858</code></pre>
</div>
</div>
</section>
<section id="高维协方差矩阵的稀疏结构假设与相关估计方法" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> 高维协方差矩阵的稀疏结构假设与相关估计方法</h1>
<p>估计高维协方差矩阵的第一种思路是假定协方差矩阵具有一定的稀疏结构，即假定协方差矩阵<span class="math inline">\(\Sigma\)</span>中绝大多数元素为0，进而通过合适的方法对样本协方差矩阵<span class="math inline">\(S\)</span>进行修正，得到最终的稀疏估计。现有稀疏结构假设大致可分为两类：带化（bandable）矩阵和稀疏矩阵，带化矩阵是一种特殊的稀疏矩阵。</p>
<section id="带化矩阵假设下的估计方法" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="带化矩阵假设下的估计方法"><span class="header-section-number">2.1</span> 带化矩阵假设下的估计方法</h2>
<p>当<span class="math inline">\(\mathbf X\)</span>中的变量存在自然的顺序，比如时间序列变量或者空间变量，那么可以很自然的假设协方差矩阵呈现局部依赖结构，即矩阵中的非对角元素绝对值随着该元素距离对角线距离的增加而减小，直至为0。这一类协方差矩阵成为带化矩阵，其特征是非0元素集中在对角线附近的带状区域里，区域外的元素全部为0。</p>
<section id="banding方法" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="banding方法"><span class="header-section-number">2.1.1</span> Banding方法</h3>
<p>Banding方法（Bickel and Levina 2008b）是一种用于估计带化高维协方差矩阵的方法，该方法保留样本协方差矩阵主对角线及其附近的元素，将远离主对角线的元素置为零，从而在高维数据环境下获得更稳健的带化稀疏估计。具体来说，带化后的协方差矩阵<span class="math inline">\(\hat{\Sigma}^{\text{band}}\)</span>定义为： <span id="eq-banding"><span class="math display">\[
   \hat{\Sigma}_{ij}^{\text{band}} = S_{ij} \cdot I\left( |i - j| \leq k \right)
\tag{2}\]</span></span> 其中，<span class="math inline">\(I(\cdot)\)</span>是示性函数，<span class="math inline">\(k\)</span>是带宽参数，控制保留的元素范围，一般需要根据经验或者依赖交叉验证进行选择。在局部依赖假设下，Banding方法能够一致地估计真实协方差矩阵，在适当的带宽选择下，Banding方法的估计误差以较快的速度收敛到零。</p>
</section>
<section id="tapering方法" class="level3" data-number="2.1.2">
<h3 data-number="2.1.2" class="anchored" data-anchor-id="tapering方法"><span class="header-section-number">2.1.2</span> Tapering方法</h3>
<p>Tapering（渐缩，Cai, Zhang and Zhou 2010）方法是另一种用于带化高维协方差矩阵估计的方法。该方法在保留主对角线及其附近的元素的同时对元素进行平滑衰减，从而获得更稳健的估计。Tapering估计量的表达式为 <span id="eq-tapering"><span class="math display">\[
\hat{\Sigma}_{ij}^{\text{taper}} = \frac{2S_{ij}}{k}\left\{(k-|i-j|)_+-(k/2-|i-j|)_+ \right\}
\tag{3}\]</span></span> 其中<span class="math inline">\((x)_+=\max(x,0)\)</span>，<span class="math inline">\(k\)</span>同样为带宽参数。 <a href="#eq-tapering" class="quarto-xref">式&nbsp;3</a> 可以等价地表述为 <span class="math display">\[
\hat{\Sigma}_{ij}^{\text{taper}} =
\begin{cases}
S_{ij} \quad &amp;\text{if} \quad |i-j|\le k/2 \\
2(1-|i-j|/k)S_{ij} \quad &amp;\text{if} \quad k/2 &lt; |i-j| \le k \\
0 \quad &amp;\text{if} \quad |i-j|&gt;k.
\end{cases}
\]</span> 与 <a href="#eq-banding" class="quarto-xref">式&nbsp;2</a> 做对比，tapering方法对<span class="math inline">\(k/2 &lt; |i-j| \le k\)</span>区域内的元素做了平滑衰减处理，其权重由1逐步降低至0，而banding方法对该区域的元素的权重依然保持为1，继而在<span class="math inline">\(k\)</span>处骤降至0。在一定的假设条件下，tapering方法比banding方法具有更快的收敛速率。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">requireNamespace</span>(<span class="st">"cvCovEst"</span>, <span class="at">quietly =</span> <span class="cn">TRUE</span>)) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"cvCovEst"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cvCovEst)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(MASS)</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置随机种子以确保结果可重复</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 参数设置</span></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">100</span>  <span class="co"># 维度</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span>   <span class="co"># 样本量</span></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>band_width <span class="ot">&lt;-</span> <span class="fl">0.05</span>  <span class="co"># 带化处理的阈值</span></span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成空间距离矩阵（假设为1D空间上的点）</span></span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>locations <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="dv">0</span>, <span class="dv">1</span>, <span class="at">length.out =</span> p)  <span class="co"># 在[0, 1]区间上均匀分布的点</span></span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(locations, <span class="at">method =</span> <span class="st">"euclidean"</span>))</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成协方差矩阵（协方差随距离减小，超过阈值后为0）</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a>Sigma_true <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>dist_matrix <span class="sc">/</span> <span class="fl">0.02</span>)  <span class="co"># 协方差随距离指数衰减</span></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>Sigma_true[dist_matrix <span class="sc">&gt;</span> band_width] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># 带化处理</span></span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(Sigma_true) <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># 对角线元素为1</span></span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成多元正态分布数据</span></span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> <span class="fu">mvrnorm</span>(n, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, p), <span class="at">Sigma =</span> Sigma_true)</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用cvCovEst包进行协方差矩阵估计，并使用交叉验证选择带宽</span></span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>cv_banding <span class="ot">&lt;-</span> <span class="fu">cvCovEst</span>(</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">dat =</span> X,</span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimators =</span> <span class="fu">c</span>(bandingEst),</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator_params =</span> <span class="fu">list</span>(<span class="at">bandingEst =</span> <span class="fu">list</span>(<span class="at">k =</span> <span class="fu">seq</span>(<span class="dv">1</span>L, <span class="dv">10</span>L, <span class="dv">1</span>L))),</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv_scheme =</span> <span class="st">"v_fold"</span>,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">v_folds =</span> <span class="dv">5</span></span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>cv_tapering <span class="ot">&lt;-</span> <span class="fu">cvCovEst</span>(</span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">dat =</span> X,</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimators =</span> <span class="fu">c</span>(taperingEst),</span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator_params =</span> <span class="fu">list</span>(</span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">taperingEst =</span> <span class="fu">list</span>(<span class="at">k =</span> <span class="fu">seq</span>(<span class="dv">2</span>L, <span class="dv">20</span>L, <span class="dv">2</span>L))</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv_scheme =</span> <span class="st">"v_fold"</span>,</span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">v_folds =</span> <span class="dv">5</span></span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出估计的协方差矩阵</span></span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a>Sigma_banding <span class="ot">&lt;-</span> cv_banding<span class="sc">$</span>estimate</span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a>Sigma_tapering <span class="ot">&lt;-</span> cv_tapering<span class="sc">$</span>estimate</span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 输出估计所选择的带宽</span></span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"banding方法的带宽："</span>, cv_banding<span class="sc">$</span>estimator)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>banding方法的带宽： bandingEst, k = 3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"tapering方法的带宽："</span>, cv_tapering<span class="sc">$</span>estimator)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tapering方法的带宽： taperingEst, k = 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"banding估计的协方差矩阵（前5x5）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>banding估计的协方差矩阵（前5x5）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Sigma_banding[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            [,1]      [,2]      [,3]        [,4]      [,5]
[1,]  0.93750898 0.6236684 0.3547426 -0.01915142 0.0000000
[2,]  0.62366837 1.0784256 0.5959016  0.26162694 0.1375792
[3,]  0.35474256 0.5959016 0.7676698  0.39133696 0.3005238
[4,] -0.01915142 0.2616269 0.3913370  0.75291543 0.4742981
[5,]  0.00000000 0.1375792 0.3005238  0.47429814 1.0099289</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"tapering估计的协方差矩阵（前5x5）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>tapering估计的协方差矩阵（前5x5）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(Sigma_tapering[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>            [,1]       [,2]      [,3]        [,4]       [,5]
[1,]  0.93750898 0.62366837 0.3547426 -0.00957571 0.00000000
[2,]  0.62366837 1.07842562 0.5959016  0.26162694 0.06878958
[3,]  0.35474256 0.59590156 0.7676698  0.39133696 0.30052384
[4,] -0.00957571 0.26162694 0.3913370  0.75291543 0.47429814
[5,]  0.00000000 0.06878958 0.3005238  0.47429814 1.00992891</code></pre>
</div>
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较估计矩阵和真实矩阵的Frobenius范数误差</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>error <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="fu">norm</span>(Sigma_banding <span class="sc">-</span> Sigma_true, <span class="at">type =</span> <span class="st">"F"</span>),</span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>           <span class="fu">norm</span>(Sigma_tapering <span class="sc">-</span> Sigma_true, <span class="at">type =</span> <span class="st">"F"</span>))</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"banding和tapering方法估计矩阵与真实矩阵的Frobenius范数误差分别为："</span>, error, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>banding和tapering方法估计矩阵与真实矩阵的Frobenius范数误差分别为： 4.488601 4.499928 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化真实协方差矩阵和估计协方差矩阵</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(reshape2)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 真实协方差矩阵可视化</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>Sigma_true_melted <span class="ot">&lt;-</span> <span class="fu">melt</span>(Sigma_true)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Sigma_true_melted, <span class="fu">aes</span>(<span class="at">x =</span> Var1, <span class="at">y =</span> Var2, <span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"True Covariance Matrix"</span>, <span class="at">x =</span> <span class="st">"Variable"</span>, <span class="at">y =</span> <span class="st">"Variable"</span>) <span class="sc">+</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-3-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># banding估计协方差矩阵可视化</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>Sigma_banding_melted <span class="ot">&lt;-</span> <span class="fu">melt</span>(Sigma_banding)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Sigma_banding_melted, <span class="fu">aes</span>(<span class="at">x =</span> Var1, <span class="at">y =</span> Var2, <span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Banding Estimated Covariance Matrix"</span>, <span class="at">x =</span> <span class="st">"Variable"</span>, <span class="at">y =</span> <span class="st">"Variable"</span>) <span class="sc">+</span></span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-3-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># tapering估计协方差矩阵可视化</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>Sigma_tapering_melted <span class="ot">&lt;-</span> <span class="fu">melt</span>(Sigma_tapering)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(Sigma_tapering_melted, <span class="fu">aes</span>(<span class="at">x =</span> Var1, <span class="at">y =</span> Var2, <span class="at">fill =</span> value)) <span class="sc">+</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_tile</span>() <span class="sc">+</span></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_fill_gradient2</span>(<span class="at">low =</span> <span class="st">"blue"</span>, <span class="at">mid =</span> <span class="st">"white"</span>, <span class="at">high =</span> <span class="st">"red"</span>, <span class="at">midpoint =</span> <span class="dv">0</span>) <span class="sc">+</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Tapering Estimated Covariance Matrix"</span>, <span class="at">x =</span> <span class="st">"Variable"</span>, <span class="at">y =</span> <span class="st">"Variable"</span>) <span class="sc">+</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>()</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-3-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
<section id="稀疏性假设下的阈值估计方法及其拓展" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="稀疏性假设下的阈值估计方法及其拓展"><span class="header-section-number">2.2</span> 稀疏性假设下的阈值估计方法及其拓展</h2>
<section id="hard-thresholding硬阈值法" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="hard-thresholding硬阈值法"><span class="header-section-number">2.2.1</span> Hard Thresholding（硬阈值法）</h3>
<p>硬阈值法（Bickel and Levena 2008a）是一种基于稀疏性假设的高维协方差矩阵估计方法，该方法对样本协方差矩阵<span class="math inline">\(S\)</span>的非对角线元素<span class="math inline">\(S_{ij}\)</span>进行硬阈值处理，保留绝对值大于阈值<span class="math inline">\(\omega\)</span>的元素，将小于等于<span class="math inline">\(\omega\)</span>的元素置为零： <span id="eq-thresholding"><span class="math display">\[
   \hat{\Sigma}_{ij}^{\text{hard-thresh}} = \begin{cases}
   S_{ij} \quad &amp;\text{if}\quad i=j \\
   S_{ij}\cdot I\left( |S_{ij}| &gt; \omega \right) \quad &amp;\text{if}\quad i\ne j
   \end{cases}
\tag{4}\]</span></span> 其中<span class="math inline">\(\omega&gt;0\)</span>为预先给定的阈值水平。当随机向量<span class="math inline">\(\mathbf X\)</span>为Gaussian或者sub-Gaussian时，理论上阈值可以设定为<span class="math inline">\(\omega = C\sqrt{\frac{\log p}{n}}\)</span>，其中<span class="math inline">\(C&gt;0\)</span>，但是该方式仍然包含未知的常数<span class="math inline">\(C\)</span>，实际中阈值选择通常基于交叉验证确定。硬阈值法方法易于理解和实现，计算效率高，能够有效利用高维数据的稀疏性，减少噪声。在一定的假设条件下，硬阈值法具有一致性。</p>
</section>
<section id="soft-thresholding软阈值法" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="soft-thresholding软阈值法"><span class="header-section-number">2.2.2</span> Soft Thresholding（软阈值法）</h3>
<p>软阈值法在硬阈值的基础上融入了压缩估计，它的核心思想是通过将小于阈值的元素向零截断，同时减少大于阈值的元素的绝对值，从而实现数据的平滑稀疏化。其表达式为 <span id="eq-soft-thresholding"><span class="math display">\[
   \hat{\Sigma}_{ij}^{\text{soft-thresh}} = \begin{cases}
   S_{ij} \quad &amp;\text{if}\quad i=j \\
   \mathrm{sign}(S_{ij})(|S_{ij}|- \omega)_+ \quad &amp;\text{if}\quad i\ne j
   \end{cases}
\tag{5}\]</span></span> 其中<span class="math inline">\(\omega&gt;0\)</span>为阈值参数。具体而言，当样本协方差矩阵非对角线元素<span class="math inline">\(|S_{ij}|&lt;\omega\)</span>时将其设置为0，当<span class="math inline">\(S_{ij}&gt;\omega\)</span>时将其向0进行线性压缩<span class="math inline">\(S_{ij}-\omega\)</span>，当<span class="math inline">\(S_{ij}&lt;-\omega\)</span>时将其向0调整为<span class="math inline">\(S_{ij}+\omega\)</span>。</p>
</section>
<section id="generalized-thresholding广义阈值法" class="level3" data-number="2.2.3">
<h3 data-number="2.2.3" class="anchored" data-anchor-id="generalized-thresholding广义阈值法"><span class="header-section-number">2.2.3</span> Generalized Thresholding（广义阈值法）</h3>
<p>广义阈值法是硬阈值法和软阈值法的进一步拓展，该方法使用一般化的压缩函数<span class="math inline">\(h(\cdot;\omega)\)</span>作用于样本协方差矩阵的非对角线元素： <span id="eq-generalized-thresholding"><span class="math display">\[
   \hat{\Sigma}_{ij}^{\text{thresh}} = \begin{cases}
   S_{ij} \quad &amp;\text{if}\quad i=j \\
   h(S_{ij};\omega) \quad &amp;\text{if}\quad i\ne j
   \end{cases}
\tag{6}\]</span></span> 其中<span class="math inline">\(\omega\)</span>为阈值参数。压缩函数<span class="math inline">\(h(\cdot;\omega)\)</span>须满足3个条件： (1). <span class="math inline">\(h(z;\omega)=0\)</span>当<span class="math inline">\(|z|\le \omega\)</span>； (2). <span class="math inline">\(|h(z;\omega)|\le |z|\)</span>； (3). <span class="math inline">\(|h(z;\omega)-z|\le \omega\)</span>。 第1个条件是阈值效应，即将绝对值小于<span class="math inline">\(\omega\)</span>的值截断为0，第2个条件是压缩效应，第3个条件规定了压缩的程度。</p>
<p>硬阈值法和软阈值法作为广义阈值法的特例，它们对应的压缩函数分别为 <span class="math display">\[
h^{\text{hard-thresh}}(z;\omega)=z\cdot I(|z|&gt;\omega),
\]</span> 以及 <span class="math display">\[
h^{\text{soft-thresh}}(z;\omega)=\mathrm{sign}(z)(|z|-\omega)_+.
\]</span> 另外两种常用的压缩函数分别是SCAD（Smoothly Clipped Absolute Deviation）： <span class="math display">\[
h^{\text{SCAD}}(z;\omega)=\begin{cases}
    \mathrm{sign}(z)(|z|-\omega)_+ \quad &amp;|z|\le 2\omega \\
    \{(a-1)z-\mathrm{sign}(z)a\omega\}/(a-2) \quad &amp; 2\omega &lt;|z|\le a\omega\\
    z \quad &amp;|z|&gt;a\omega
    \end{cases}
\]</span> 其中<span class="math inline">\(a&gt;2\)</span>为形状参数，一般取值3.7，以及MCP（minimax concave penalty）： <span class="math display">\[
h^{\text{MCP}}(z;\omega) = \begin{cases}
(a/(a-1))\mathrm{sign}(z)(|z|-\omega)_+ \quad &amp; |z|\le a\omega\\
z \quad &amp; |z|&gt;a\omega
\end{cases}
\]</span> 其中形状参数<span class="math inline">\(a&gt;1\)</span>一般取值为3。</p>
<div class="cell">
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-4-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>上图绘制了硬阈值、软阈值、SCAD和MCP四种压缩函数在阈值<span class="math inline">\(\omega=1\)</span>时的图像。首先，硬阈值压缩函数是不连续的，在阈值处直接将<span class="math inline">\(|z|\)</span>截断为0；第二，由于在阈值之外的区域引入了线性压缩，软阈值压缩函数连续，但是同时在<span class="math inline">\(|z|\)</span>较大的区域引入了偏差，而绝对值较大区域往往是不需要进行额外压缩估计的；第三，SCAD和MCP在保留了软阈值的连续性的同时，避免了在绝对值较大区域进行压缩估计从而出现偏差。</p>
</section>
<section id="广义阈值法的等价惩罚回归表示" class="level3" data-number="2.2.4">
<h3 data-number="2.2.4" class="anchored" data-anchor-id="广义阈值法的等价惩罚回归表示"><span class="header-section-number">2.2.4</span> 广义阈值法的等价惩罚回归表示</h3>
<p>广义阈值法 <a href="#eq-generalized-thresholding" class="quarto-xref">式&nbsp;6</a> 可以等价地表示为以下惩罚最小二乘回归的解： <span id="eq-thresholding-penalization"><span class="math display">\[
\hat{\Sigma}^{\text{thresh}} = \arg\min_{\Sigma} \left\{ \frac{1}{2} \|S - \Sigma\|_F^2 + \sum_{i \neq j} p(|\Sigma_{ij}|;\omega) \right\}
\tag{7}\]</span></span> 其中，<span class="math inline">\(S\)</span>为样本协方差矩阵，<span class="math inline">\(p(\cdot;\omega)\)</span>为惩罚函数，需要指出的是，我们只对非对角线元素施加惩罚，<span class="math inline">\(\|\cdot\|_F\)</span>表示Frobenius范数，一个<span class="math inline">\(p\times p\)</span>维矩阵<span class="math inline">\(A\)</span>的Frobenius范数表示为<span class="math inline">\(\|A\|_F=\sqrt{\sum_{i=1}^p\sum_{j=1}^p A_{ij}^2}\)</span>。</p>
<p>Antoniadis and Fan (2001) 仔细讨论了广义阈值法中的压缩函数与惩罚最小二乘回归中的惩罚函数一一对应关系，总的来说，压缩函数是惩罚函数的的次梯度。 <a href="#tbl-threshold-penalty" class="quarto-xref">表&nbsp;1</a> 分别列出了硬阈值、软阈值、SCAD以及MCP四种方法对应的压缩函数和惩罚函数。需要指出的是，软阈值方法对应的正好是Lasso惩罚函数。</p>
<div id="tbl-threshold-penalty" class="quarto-float quarto-figure quarto-figure-center anchored">
<figure class="quarto-float quarto-float-tbl figure">
<figcaption class="quarto-float-caption-top quarto-float-caption quarto-float-tbl" id="tbl-threshold-penalty-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
表&nbsp;1: 压缩函数与惩罚函数的对应关系
</figcaption>
<div aria-describedby="tbl-threshold-penalty-caption-0ceaefa1-69ba-4598-a22c-09a6ac19f8ca">
<table class="caption-top table">
<colgroup>
<col style="width: 10%">
<col style="width: 44%">
<col style="width: 44%">
</colgroup>
<thead>
<tr class="header">
<th><strong>方法</strong></th>
<th><strong>压缩函数</strong></th>
<th><strong>惩罚函数</strong></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td><strong>硬阈值</strong></td>
<td><span class="math inline">\(h(z;\omega) = z \cdot I(|z| &gt; \omega)\)</span></td>
<td><span class="math inline">\(p(z;\omega) = \omega^2 - \frac{(|z| - \omega)^2}{2} \cdot I(|z| &lt; \omega)\)</span></td>
</tr>
<tr class="even">
<td><strong>软阈值</strong></td>
<td><span class="math inline">\(h(z;\omega) = \text{sign}(z) \cdot (|z| - \omega)_+\)</span></td>
<td><span class="math inline">\(p(z;\omega) = \omega |z|\)</span></td>
</tr>
<tr class="odd">
<td><strong>SCAD</strong></td>
<td><span class="math inline">\(h(z;\omega) = \begin{cases} \text{sign}(z) \cdot (|z| - \omega)_+ &amp; \text{if } |z| \leq 2\omega, \\\ \frac{(a-1)z - \text{sign}(z) \cdot a \omega}{a-2} &amp; \text{if } 2\omega &lt; |z| \leq a\omega, \\ z &amp; \text{if } |z| &gt; a\omega \end{cases}\)</span></td>
<td><span class="math inline">\(p(z;\omega) = \begin{cases} \omega |z| &amp; \text{if } |z| \leq \omega, \\ \frac{2a\omega |z| - z^2 - \omega^2}{2(a-1)} &amp; \text{if } \omega &lt; |z| \leq a\omega, \\ \frac{(a+1)\omega^2}{2} &amp; \text{if } |z| &gt; a\omega \end{cases}\)</span></td>
</tr>
<tr class="even">
<td><strong>MCP</strong></td>
<td><span class="math inline">\(h(z;\omega) = \begin{cases} \text{sign}(z) \cdot (|z| - \omega)_+ &amp; \text{if } |z| \leq a\omega, \\ \frac{a}{a-1} \cdot z &amp; \text{if } |z| &gt; a\omega \end{cases}\)</span></td>
<td><span class="math inline">\(p(z;\omega) = \begin{cases} \omega |z| - \frac{z^2}{2a} &amp; \text{if } |z| \leq a\omega, \\ \frac{a \omega^2}{2} &amp; \text{if } |z| &gt; a\omega \end{cases}\)</span></td>
</tr>
</tbody>
</table>
</div>
</figure>
</div>
<p>惩罚最小二乘回归不仅提供了广义阈值法的另外一种解释，还为高维协方差矩阵的稀疏估计提供了更为丰富的处理方式。一般来说，经阈值处理后的协方差矩阵估计量在大样本下是满足正定性的，但是在有限样本下正定性可能不成立。为了始终保证估计量正定、可逆，Liu et al (2014)在 <a href="#eq-thresholding-penalization" class="quarto-xref">式&nbsp;7</a> 中融入了正定性限制条件： <span class="math display">\[
\hat{\Sigma}^{\text{EC2}} = \arg\min_{\lambda_{min}(\Sigma)\ge \tau} \left\{ \frac{1}{2} \|S - \Sigma\|_F^2 + \sum_{i \neq j} p(|\Sigma_{ij}|;\omega) \right\},
\]</span> 其中约束条件<span class="math inline">\(\lambda_{min}(\Sigma)\ge \tau\)</span>，即矩阵估计量的最小特征值存在下界<span class="math inline">\(\tau&gt;0\)</span>，保证了所得到的协方差矩阵估计既满足稀疏性又符合正定要求。这一估计量称为EC2（estimation of covariance with eigenvalue constraints）估计量。</p>
</section>
<section id="阈值法的自适应改进" class="level3" data-number="2.2.5">
<h3 data-number="2.2.5" class="anchored" data-anchor-id="阈值法的自适应改进"><span class="header-section-number">2.2.5</span> 阈值法的自适应改进</h3>
<p>上述阈值方法的一个不足之处在于其没有将<span class="math inline">\(\mathbf X\)</span>边际分布可能存在的方差异质性纳入考虑，导致阈值处理在不同变量间存在尺度差异，或者说对于不同变量间的样本协方差施加的惩罚力度存在差异。基于这一不足，Cai and Liu (2011)在硬阈值法的基础上提出了Adaptive Thresholding（自适应阈值法）: <span class="math display">\[
   \hat{\Sigma}_{ij}^{\text{ada-thresh}} = \begin{cases}
   S_{ij} \quad &amp;\text{if}\quad i=j \\
   S_{ij}\cdot I\left( |S_{ij}|/SE(S_{ij}) &gt; \omega \right) \quad &amp;\text{if}\quad i\ne j
   \end{cases}
\]</span> 其中<span class="math inline">\(SE(S_{ij})\)</span>是协方差估计量<span class="math inline">\(S_{ij}\)</span>的标准误。这一估计量能够自适应数据的不同尾部分布特征，还能够容许数据中可能存在厚尾分布。</p>
<p>Adaptive Lasso（自适应Lasso）是一种基于软阈值方法的自适应改进，由Rothman, Levina and Zhu (2009)提出。软阈值法对应 <a href="#eq-thresholding-penalization" class="quarto-xref">式&nbsp;7</a> 中的LASSO惩罚，Adaptive Lasso在Lasso惩罚函数的基础上引入自适应权重<span class="math inline">\(\tau_{ij}\)</span>，对不同的协方差矩阵元素进行不同程度的惩罚： <span class="math display">\[
\hat{\Sigma}^{\text{ada-lasso}} = \arg\min_{\Sigma} \left\{ \frac{1}{2} \|S - \Sigma\|_F^2 +  \sum_{i \neq j} \omega \tau_{ij} |\Sigma_{ij}| \right\}
\]</span> 其中权重通常基于初始估计（如样本协方差矩阵）计算，比如 <span class="math display">\[
\tau_{ij} = \frac{1}{|S_{ij}|^\gamma}
\]</span> 其中，<span class="math inline">\(\gamma &gt; 0\)</span>是控制权重衰减速度的参数。</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装并加载必要的包</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cvCovEst)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 设置随机种子</span></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成一般性的稀疏高维协方差矩阵</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">50</span>  <span class="co"># 样本量</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>p <span class="ot">&lt;-</span> <span class="dv">100</span>   <span class="co"># 变量维度</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 随机生成二维地理坐标</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">123</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>coords <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="fu">runif</span>(p <span class="sc">*</span> <span class="dv">2</span>, <span class="dv">0</span>, <span class="dv">10</span>), <span class="at">nrow =</span> p, <span class="at">ncol =</span> <span class="dv">2</span>)  <span class="co"># 生成 p 个点的坐标</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算距离矩阵</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>dist_matrix <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">dist</span>(coords))</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 基于距离生成稀疏协方差矩阵</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>threshold <span class="ot">&lt;-</span> <span class="dv">2</span>  <span class="co"># 距离阈值</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>true_cov <span class="ot">&lt;-</span> <span class="fu">exp</span>(<span class="sc">-</span>dist_matrix)  <span class="co"># 使用指数核函数生成协方差</span></span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>true_cov[dist_matrix <span class="sc">&gt;</span> threshold] <span class="ot">&lt;-</span> <span class="dv">0</span>  <span class="co"># 距离超过阈值的设为 0</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a><span class="fu">diag</span>(true_cov) <span class="ot">&lt;-</span> <span class="dv">1</span>  <span class="co"># 对角线设为 1</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a><span class="co"># 生成多元正态分布数据</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>X <span class="ot">&lt;-</span> MASS<span class="sc">::</span><span class="fu">mvrnorm</span>(n, <span class="at">mu =</span> <span class="fu">rep</span>(<span class="dv">0</span>, p), <span class="at">Sigma =</span> true_cov)</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 cvCovEst 包进行协方差矩阵估计</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="co"># 将硬阈值、SCAD 和自适应 Lasso 作为列表传入</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>result <span class="ot">&lt;-</span> <span class="fu">cvCovEst</span>(</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">dat =</span> X,</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimators =</span> <span class="fu">c</span>(</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    thresholdingEst,</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    scadEst,</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>    adaptiveLassoEst</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">estimator_params =</span> <span class="fu">list</span>(</span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">thresholdingEst =</span> <span class="fu">list</span>(<span class="at">gamma =</span> <span class="fu">seq</span>(<span class="fl">0.3</span>, <span class="fl">0.6</span>, <span class="at">length.out =</span> <span class="dv">20</span>)),</span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">scadEst =</span> <span class="fu">list</span>(<span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="at">length.out =</span> <span class="dv">20</span>)),</span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">adaptiveLassoEst =</span> <span class="fu">list</span>(<span class="at">lambda =</span> <span class="fu">seq</span>(<span class="fl">0.1</span>, <span class="fl">0.4</span>, <span class="at">length.out =</span> <span class="dv">20</span>), <span class="at">n =</span> <span class="fl">0.9</span>)</span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv_scheme =</span> <span class="st">"v_fold"</span>,</span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>  <span class="at">cv_loss =</span> cvMatrixFrobeniusLoss</span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a><span class="co"># 比较三种方法</span></span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>cv_sum <span class="ot">&lt;-</span> <span class="fu">summary</span>(result, <span class="at">dat_orig =</span> X)</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 三种方法对应的最优超参数</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>cv_sum<span class="sc">$</span>bestInClass</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 6
  estimator        hyperparameter                cv_risk cond_num sign  sparsity
  &lt;chr&gt;            &lt;chr&gt;                           &lt;dbl&gt;    &lt;dbl&gt; &lt;chr&gt;    &lt;dbl&gt;
1 scadEst          lambda = 0.210526315789474      2511.   -144   IND       0.82
2 adaptiveLassoEst lambda = 0.273684210526316, …   2512.   -183   IND       0.9 
3 thresholdingEst  gamma = 0.457894736842105       2520.    -13.4 IND       0.97</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 三种方法的热度图</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(result, <span class="at">dat_orig =</span> X, <span class="at">estimator =</span> <span class="fu">c</span>(<span class="st">'thresholdingEst'</span>, <span class="st">'scadEst'</span>, <span class="st">'adaptiveLassoEst'</span>), </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>     <span class="at">plot_type =</span> <span class="st">"heatmap"</span>, <span class="at">stat =</span> <span class="fu">c</span>(<span class="st">'min'</span>), <span class="at">abs_v =</span> F)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-5-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 提取最佳估计结果</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>best_estimate <span class="ot">&lt;-</span> result<span class="sc">$</span>estimate</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>best_method <span class="ot">&lt;-</span> result<span class="sc">$</span>estimator</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a><span class="co"># 最佳结果对应的各种图像</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(result, <span class="at">dat_orig =</span> X, <span class="at">estimator =</span> <span class="fu">c</span>(<span class="st">'thresholdingEst'</span>, <span class="st">'scadEst'</span>, <span class="st">'adaptiveLassoEst'</span>), </span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">plot_type =</span> <span class="st">"summary"</span>, <span class="at">stat =</span> <span class="fu">c</span>(<span class="st">'min'</span>), <span class="at">abs_v =</span> F)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Summary plot defaults to the optimal selected estimator.</code></pre>
</div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-5-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 数值比较</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Best Method:"</span>, best_method, <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best Method: scadEst, lambda = 0.210526315789474 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Frobenius Norm Error:"</span>, <span class="fu">norm</span>(true_cov <span class="sc">-</span> best_estimate, <span class="st">"F"</span>), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Frobenius Norm Error: 7.322798 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 图形比较</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">Matrix</span>(true_cov), <span class="at">main =</span> <span class="st">"True Covariance Matrix"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-5-3.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">Matrix</span>(best_estimate), <span class="at">main =</span> <span class="fu">paste</span>(<span class="st">"Best Estimate ("</span>, best_method, <span class="st">")"</span>, <span class="at">sep =</span> <span class="st">""</span>))</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-5-4.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>
</section>
<section id="无稀疏结构下的压缩估计" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> 无稀疏结构下的压缩估计</h1>
<p>前述的高维协方差矩阵估计方法均建立在总体协方差矩阵具有稀疏结构的假设之上，尽管该假设条件在一些应用中是合理的，但是并不总是适用的。比如，对股票市场中的收益率变量来说，由于所有股票收到同样的市场风险影响，股票收益率两两之间总是相关的，此时稀疏性假设就不适用了。在系数结构假设不成立的情况下，应当如何估计高维协方差矩阵？压缩估计是其中一种方法。</p>
<section id="线性压缩估计" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="线性压缩估计"><span class="header-section-number">3.1</span> 线性压缩估计</h2>
<p>Ledoit and Wolf (2004)提出了线性压缩（Linear Shrinkage）方法，通过对样本协方差矩阵向一个目标矩阵<span class="math inline">\(T\)</span>收缩，从而提高估计的稳定性和精度。为了引出该估计量，我们首先将目标矩阵确定为单位矩阵<span class="math inline">\(I_p\)</span>，通过线性组合样本协方差矩阵<span class="math inline">\(S\)</span>和目标矩阵<span class="math inline">\(I_p\)</span>，生成收缩后的协方差矩阵： <span id="eq-linear-shrinkage-v0"><span class="math display">\[
\hat{\Sigma}^{\text{shrink}} = \rho_1 S + \rho_2 I_p
\tag{8}\]</span></span> 其中，<span class="math inline">\(\rho_1\)</span>和<span class="math inline">\(\rho_2\)</span>是收缩系数，控制样本协方差矩阵和目标矩阵的权重。我们下一步通过最小化均方误差来确定最优收缩系数，即 <span class="math display">\[
   \min_{\rho_1,\rho_2}  \mathbb{E}\left[ \|\hat{\Sigma}^{\text{shrink}} - \Sigma\|_F^2 \right]
\]</span> 其中，<span class="math inline">\(\Sigma\)</span>是真实的协方差矩阵。Ledoit and Wolf (2004)给出了最优收缩系数表达式为： <span class="math display">\[
\rho_1=\frac{\alpha^2}{\delta^2},\quad \quad \rho_2=\frac{\beta^2}{\delta^2}\mu
\]</span> 其中<span class="math inline">\(m = \langle \Sigma,I_p \rangle=\mathrm{tr}(\Sigma I_p)/p\)</span>，<span class="math inline">\(\alpha^2=\|\Sigma-m I_p\|_F^2\)</span>, <span class="math inline">\(\beta^2=E\left[\|S-\Sigma\|_F^2\right]\)</span>，以及<span class="math inline">\(\delta^2=E\left[\|S-m I_p\|_F^2 \right]\)</span>。具体来说，<span class="math inline">\(m\)</span>是总体协方差矩阵对角线元素的平均值，即<span class="math inline">\(\mathbf X\)</span>中各变量方差的平均值，剩余3个量满足关系式<span class="math inline">\(\alpha^2+\beta^2=\delta^2\)</span>。基于此，我们令<span class="math inline">\(\rho = \frac{\alpha^2}{\delta^2}\)</span>，那么 <a href="#eq-linear-shrinkage-v0" class="quarto-xref">式&nbsp;8</a> 此时可以表示为 <span id="eq-linear-shrinkage"><span class="math display">\[
\hat{\Sigma}^{\text{shrink}} = \rho S + (1-\rho) T
\tag{9}\]</span></span> 其中目标矩阵变为<span class="math inline">\(T=m I_p\)</span>，参数<span class="math inline">\(m\)</span>可以由数据中各变量样本方差的平均值估计，即<span class="math inline">\(\hat m = \frac{1}{p}\sum_{i=1}^p S_{ii}\)</span>。参数<span class="math inline">\(\rho\)</span>可以有两种方法进行选择：交叉验证和插值法。使用插值法时需要基于样本数据估计出<span class="math inline">\(\beta^2\)</span>和<span class="math inline">\(\delta^2\)</span>，一种估计方式是<span class="math inline">\(\hat \delta^2 = \|S-\hat m I_p\|_F^2\)</span>以及 <span class="math display">\[
\hat \beta^2 = \frac{1}{n}\sum_{t=1}^n \|(\mathbf X_t-\bar{\mathbf X})(\mathbf X_t-\bar{\mathbf X})^T - S \|_F^2,
\]</span> 那么<span class="math inline">\(\hat \rho = 1-\hat \beta^2/\hat \delta^2\)</span>。</p>
<p>线性压缩估计量 <a href="#eq-linear-shrinkage" class="quarto-xref">式&nbsp;9</a> 本质上是将样本协方差矩阵的特征值向<span class="math inline">\(m\)</span>进行线性压缩。设<span class="math inline">\(\lambda_1\ge \lambda_2\ge \dots \ge \lambda_p\)</span>为样本协方差矩阵<span class="math inline">\(S\)</span>的特征值，<span class="math inline">\(U\)</span>是对应的特征向量矩阵，那么有<span class="math inline">\(S=U \Lambda U^T\)</span>，其中<span class="math inline">\(\Lambda\)</span>是对角线元素为<span class="math inline">\(\lambda_1,\cdots,\lambda_p\)</span>的对角矩阵。根据<span class="math inline">\(I_p = UU^T\)</span>，那么 <a href="#eq-linear-shrinkage" class="quarto-xref">式&nbsp;9</a> 可以写作 <span class="math display">\[
\hat{\Sigma}^{\text{shrink}} = U\left[\rho\Lambda+(1-\rho)mI_p \right]U^T,
\]</span> 其中，经线性压缩调整后的特征值写作<span class="math inline">\(\rho \lambda_i+(1-\rho)m\)</span>。在高维情形下，样本协方差矩阵的特征值分布会偏离总体协方差矩阵特征值的分布，表现在样本协方差矩阵特征值的分布会更加分散，即严重高估最大特征的同时也会大大低估最小特征值。为解决这一问题，线性压缩估计量将样本协方差特征值向<span class="math inline">\(m\)</span>收缩靠拢，从而获得更为稳健的估计。</p>
</section>
<section id="非线性压缩估计" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="非线性压缩估计"><span class="header-section-number">3.2</span> 非线性压缩估计</h2>
<p>Ledoit and Wolf (2020)进一步将线性压缩拓展到非线性收缩（Nonlinear Shrinkage）方法。与线性收缩方法不同，非线性收缩方法通过非线性变换<span class="math inline">\(\delta(\cdot)\)</span>对样本协方差矩阵的特征值进行调整。具体过程如下：第一步，对样本协方差矩阵进行特征值分解<span class="math inline">\(S = U \Lambda U^T\)</span>，其中，<span class="math inline">\(U\)</span>是特征向量矩阵，<span class="math inline">\(\Lambda\)</span>是对角矩阵，包含样本协方差矩阵的特征值<span class="math inline">\(\lambda_1, \lambda_2, \dots, \lambda_p\)</span>；第二步，对样本协方差矩阵的特征值<span class="math inline">\(\lambda_i,i=1,\cdots,p\)</span>进行非线性调整，生成收缩后的特征值<span class="math inline">\(\delta_i = \delta(\lambda_i)\)</span>以及响应的对角矩阵<span class="math inline">\(\Delta\)</span>，那么非线性压缩估计量可以表示为 <span id="eq-nonlinear-shrinkage"><span class="math display">\[
\hat{\Sigma}^{\text{nl-shrink}} = U\Delta U^T.
\tag{10}\]</span></span></p>
<p>接下来的问题是：非线性变换<span class="math inline">\(\delta(\cdot)\)</span>应使用什么样的形式？Ledoit and Wolf (2020)给出了如下变换： <span id="eq-nonlinear-transform"><span class="math display">\[
\delta(x) = \frac{x}{[\pi c x f(x)]^2+[1-c-\pi cx\mathcal H_f(x)]^2},
\tag{11}\]</span></span> 其中，常数<span class="math inline">\(c=\lim_{n \to \infty} p/n\)</span>，注意高维下我们一般假设<span class="math inline">\(p \to \infty\)</span>随着<span class="math inline">\(n \to \infty\)</span>，函数<span class="math inline">\(f\)</span>可以粗略地理解为总体协方差矩阵特征值分布的密度函数，<span class="math inline">\(\mathcal H_f\)</span>是函数<span class="math inline">\(f\)</span>的希尔伯特变换（Hilbert Transform）： <span class="math display">\[
\mathcal H_f(x) = \frac{1}{\pi}\mathrm{PV} \int_{-\infty}^\infty f(t)\frac{dt}{t-x}.
\]</span> 上式中，PV是指柯西主值（Principal Value），由于积分函数在<span class="math inline">\(t=x\)</span>处存在无穷点，柯西主值 <span class="math display">\[
\mathrm{PV} \int_{-\infty}^\infty f(t)\frac{dt}{t-x} \equiv \lim_{\varepsilon \to 0^+}\left[ \int_{-\infty}^{x-\varepsilon}f(t)\frac{dt}{t-x}+ \int_{x+\varepsilon}^\infty f(t)\frac{dt}{t-x}\right]
\]</span> 可以更严格地处理这个奇异积分。希尔伯特变换的作用类似于一种局部调整机制，根据函数在附近点的值对当前位置的值进行增强或减弱：当附近有较大的函数值时，希尔伯特变换会将函数值向上调整；当附近有较小的函数值时，希尔伯特变换会将函数值向下调整，类似于“削峰填谷”，达到“收缩”的效果。</p>
<p>非线性变换 <a href="#eq-nonlinear-transform" class="quarto-xref">式&nbsp;11</a> 中包含两个未知的量：常数<span class="math inline">\(c\)</span>和密度函数<span class="math inline">\(f\)</span>。其中常数<span class="math inline">\(c\)</span>可以简单地使用<span class="math inline">\(\hat c = p/n\)</span>进行估计。对于密度函数<span class="math inline">\(f\)</span>，Ledoit and Wolf (2020)使用<span class="math inline">\(\lambda_1,\lambda_2,\cdots,\lambda_p\)</span>作为“样本点”，并结合变带宽核密度估计量进行估计： <span class="math display">\[
\hat f(x) = \frac{1}{p \lambda_i h}\sum_{i=1}^p K\left(\frac{x-\lambda_i}{\lambda_i h} \right),
\]</span> 其中固定带宽<span class="math inline">\(h \to 0\)</span>需要在估计前进行选择，Ledoit and Wolf (2020)建议将其设置为<span class="math inline">\(h=n^{-1/3}\)</span>，<span class="math inline">\(K(\cdot)\)</span>为核函数。由于希尔伯特变换是线性算子，该估计量对应的希尔伯特变换写作 <span class="math display">\[
\mathcal H_{\hat f} = \frac{1}{p \lambda_i h}\sum_{i=1}^p \mathcal H_K\left(\frac{x-\lambda_i}{\lambda_i h} \right).
\]</span> 如果使用常用的Epanechnikov核函数<span class="math inline">\(K(x) = \frac{3}{4\sqrt{5}}(1-x^2/5)_+\)</span>，对应的希尔伯特变换写作 <span class="math display">\[
\mathcal H_K(x)=\begin{cases}
-\frac{3x}{10\pi}+\frac{3}{4\sqrt{5}\pi}\left(1-\frac{x^2}{5}\right)\log\left| \frac{\sqrt{5}-x}{\sqrt{5}+x} \right| \quad &amp;|x|\ne \sqrt{5}\\
-\frac{3x}{10\pi} \quad &amp; |x|=\sqrt{5}.
\end{cases}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 安装和加载所需包</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(pedquant)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Warning: package 'pedquant' was built under R version 4.4.3</code></pre>
</div>
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>── Attaching core tidyverse packages ──────────────────────── tidyverse 2.0.0 ──
✔ forcats   1.0.0     ✔ stringr   1.5.1
✔ lubridate 1.9.3     ✔ tibble    3.2.1
✔ purrr     1.0.2     ✔ tidyr     1.3.1
✔ readr     2.1.5     
── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──
✖ purrr::%||%()   masks base::%||%()
✖ tidyr::expand() masks Matrix::expand()
✖ dplyr::filter() masks stats::filter()
✖ dplyr::lag()    masks stats::lag()
✖ tidyr::pack()   masks Matrix::pack()
✖ dplyr::select() masks MASS::select()
✖ tidyr::unpack() masks Matrix::unpack()
ℹ Use the conflicted package (&lt;http://conflicted.r-lib.org/&gt;) to force all conflicts to become errors</code></pre>
</div>
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 沪深300成分股股票代码向量</span></span>
<span id="cb50-2"><a href="#cb50-2" aria-hidden="true" tabindex="-1"></a>hs300_stock_codes <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb50-3"><a href="#cb50-3" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600000.SH"</span>, <span class="st">"600004.SH"</span>, <span class="st">"600009.SH"</span>, <span class="st">"600010.SH"</span>, <span class="st">"600011.SH"</span>, <span class="st">"600015.SH"</span>,</span>
<span id="cb50-4"><a href="#cb50-4" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600016.SH"</span>, <span class="st">"600018.SH"</span>, <span class="st">"600019.SH"</span>, <span class="st">"600025.SH"</span>, <span class="st">"600028.SH"</span>, <span class="st">"600029.SH"</span>,</span>
<span id="cb50-5"><a href="#cb50-5" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600030.SH"</span>, <span class="st">"600031.SH"</span>, <span class="st">"600036.SH"</span>, <span class="st">"600048.SH"</span>, <span class="st">"600050.SH"</span>, <span class="st">"600104.SH"</span>,</span>
<span id="cb50-6"><a href="#cb50-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600109.SH"</span>, <span class="st">"600111.SH"</span>, <span class="st">"600115.SH"</span>, <span class="st">"600118.SH"</span>, <span class="st">"600170.SH"</span>, <span class="st">"600176.SH"</span>,</span>
<span id="cb50-7"><a href="#cb50-7" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600177.SH"</span>, <span class="st">"600183.SH"</span>, <span class="st">"600188.SH"</span>, <span class="st">"600196.SH"</span>, <span class="st">"600208.SH"</span>, <span class="st">"600219.SH"</span>,</span>
<span id="cb50-8"><a href="#cb50-8" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600221.SH"</span>, <span class="st">"600233.SH"</span>, <span class="st">"600271.SH"</span>, <span class="st">"600276.SH"</span>, <span class="st">"600297.SH"</span>, <span class="st">"600309.SH"</span>,</span>
<span id="cb50-9"><a href="#cb50-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600332.SH"</span>, <span class="st">"600340.SH"</span>, <span class="st">"600346.SH"</span>, <span class="st">"600352.SH"</span>, <span class="st">"600362.SH"</span>, <span class="st">"600369.SH"</span>,</span>
<span id="cb50-10"><a href="#cb50-10" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600383.SH"</span>, <span class="st">"600390.SH"</span>, <span class="st">"600406.SH"</span>, <span class="st">"600436.SH"</span>, <span class="st">"600438.SH"</span>, <span class="st">"600482.SH"</span>,</span>
<span id="cb50-11"><a href="#cb50-11" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600487.SH"</span>, <span class="st">"600489.SH"</span>, <span class="st">"600498.SH"</span>, <span class="st">"600516.SH"</span>, <span class="st">"600519.SH"</span>, <span class="st">"600522.SH"</span>,</span>
<span id="cb50-12"><a href="#cb50-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600547.SH"</span>, <span class="st">"600570.SH"</span>, <span class="st">"600585.SH"</span>, <span class="st">"600588.SH"</span>, <span class="st">"600606.SH"</span>, <span class="st">"600637.SH"</span>,</span>
<span id="cb50-13"><a href="#cb50-13" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600655.SH"</span>, <span class="st">"600660.SH"</span>, <span class="st">"600663.SH"</span>, <span class="st">"600674.SH"</span>, <span class="st">"600690.SH"</span>, <span class="st">"600703.SH"</span>,</span>
<span id="cb50-14"><a href="#cb50-14" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600705.SH"</span>, <span class="st">"600741.SH"</span>, <span class="st">"600745.SH"</span>, <span class="st">"600760.SH"</span>, <span class="st">"600795.SH"</span>, <span class="st">"600809.SH"</span>,</span>
<span id="cb50-15"><a href="#cb50-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600837.SH"</span>, <span class="st">"600848.SH"</span>, <span class="st">"600867.SH"</span>, <span class="st">"600886.SH"</span>, <span class="st">"600887.SH"</span>, <span class="st">"600893.SH"</span>,</span>
<span id="cb50-16"><a href="#cb50-16" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600900.SH"</span>, <span class="st">"600905.SH"</span>, <span class="st">"600919.SH"</span>, <span class="st">"600926.SH"</span>, <span class="st">"600928.SH"</span>, <span class="st">"600929.SH"</span>,</span>
<span id="cb50-17"><a href="#cb50-17" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600933.SH"</span>, <span class="st">"600938.SH"</span>, <span class="st">"600958.SH"</span>, <span class="st">"600959.SH"</span>, <span class="st">"600968.SH"</span>, <span class="st">"600977.SH"</span>,</span>
<span id="cb50-18"><a href="#cb50-18" aria-hidden="true" tabindex="-1"></a>  <span class="st">"600989.SH"</span>, <span class="st">"600998.SH"</span>, <span class="st">"600999.SH"</span>, <span class="st">"601006.SH"</span>, <span class="st">"601009.SH"</span>, <span class="st">"601012.SH"</span>,</span>
<span id="cb50-19"><a href="#cb50-19" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601018.SH"</span>, <span class="st">"601021.SH"</span>, <span class="st">"601066.SH"</span>, <span class="st">"601077.SH"</span>, <span class="st">"601088.SH"</span>, <span class="st">"601099.SH"</span>,</span>
<span id="cb50-20"><a href="#cb50-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601100.SH"</span>, <span class="st">"601108.SH"</span>, <span class="st">"601111.SH"</span>, <span class="st">"601117.SH"</span>, <span class="st">"601138.SH"</span>, <span class="st">"601155.SH"</span>,</span>
<span id="cb50-21"><a href="#cb50-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601162.SH"</span>, <span class="st">"601166.SH"</span>, <span class="st">"601169.SH"</span>, <span class="st">"601186.SH"</span>, <span class="st">"601198.SH"</span>, <span class="st">"601211.SH"</span>,</span>
<span id="cb50-22"><a href="#cb50-22" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601216.SH"</span>, <span class="st">"601225.SH"</span>, <span class="st">"601229.SH"</span>, <span class="st">"601231.SH"</span>, <span class="st">"601236.SH"</span>, <span class="st">"601238.SH"</span>,</span>
<span id="cb50-23"><a href="#cb50-23" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601288.SH"</span>, <span class="st">"601318.SH"</span>, <span class="st">"601319.SH"</span>, <span class="st">"601328.SH"</span>, <span class="st">"601336.SH"</span>, <span class="st">"601360.SH"</span>,</span>
<span id="cb50-24"><a href="#cb50-24" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601377.SH"</span>, <span class="st">"601390.SH"</span>, <span class="st">"601398.SH"</span>, <span class="st">"601555.SH"</span>, <span class="st">"601577.SH"</span>, <span class="st">"601600.SH"</span>,</span>
<span id="cb50-25"><a href="#cb50-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601601.SH"</span>, <span class="st">"601607.SH"</span>, <span class="st">"601618.SH"</span>, <span class="st">"601628.SH"</span>, <span class="st">"601633.SH"</span>, <span class="st">"601658.SH"</span>,</span>
<span id="cb50-26"><a href="#cb50-26" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601668.SH"</span>, <span class="st">"601669.SH"</span>, <span class="st">"601688.SH"</span>, <span class="st">"601696.SH"</span>, <span class="st">"601698.SH"</span>, <span class="st">"601727.SH"</span>,</span>
<span id="cb50-27"><a href="#cb50-27" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601766.SH"</span>, <span class="st">"601788.SH"</span>, <span class="st">"601800.SH"</span>, <span class="st">"601808.SH"</span>, <span class="st">"601818.SH"</span>, <span class="st">"601828.SH"</span>,</span>
<span id="cb50-28"><a href="#cb50-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601838.SH"</span>, <span class="st">"601857.SH"</span>, <span class="st">"601878.SH"</span>, <span class="st">"601881.SH"</span>, <span class="st">"601888.SH"</span>, <span class="st">"601898.SH"</span>,</span>
<span id="cb50-29"><a href="#cb50-29" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601899.SH"</span>, <span class="st">"601901.SH"</span>, <span class="st">"601916.SH"</span>, <span class="st">"601919.SH"</span>, <span class="st">"601933.SH"</span>, <span class="st">"601939.SH"</span>,</span>
<span id="cb50-30"><a href="#cb50-30" aria-hidden="true" tabindex="-1"></a>  <span class="st">"601985.SH"</span>, <span class="st">"601988.SH"</span>, <span class="st">"601989.SH"</span>, <span class="st">"601992.SH"</span>, <span class="st">"601997.SH"</span>, <span class="st">"601998.SH"</span>,</span>
<span id="cb50-31"><a href="#cb50-31" aria-hidden="true" tabindex="-1"></a>  <span class="st">"603019.SH"</span>, <span class="st">"603156.SH"</span>, <span class="st">"603160.SH"</span>, <span class="st">"603259.SH"</span>, <span class="st">"603288.SH"</span>, <span class="st">"603369.SH"</span>,</span>
<span id="cb50-32"><a href="#cb50-32" aria-hidden="true" tabindex="-1"></a>  <span class="st">"603501.SH"</span>, <span class="st">"603658.SH"</span>, <span class="st">"603799.SH"</span>, <span class="st">"603833.SH"</span>, <span class="st">"603899.SH"</span>, <span class="st">"603986.SH"</span>,</span>
<span id="cb50-33"><a href="#cb50-33" aria-hidden="true" tabindex="-1"></a>  <span class="st">"603993.SH"</span>, <span class="st">"688008.SH"</span>, <span class="st">"688009.SH"</span>, <span class="st">"688012.SH"</span>, <span class="st">"688036.SH"</span>, <span class="st">"688111.SH"</span>,</span>
<span id="cb50-34"><a href="#cb50-34" aria-hidden="true" tabindex="-1"></a>  <span class="st">"688126.SH"</span>, <span class="st">"688169.SH"</span>, <span class="st">"688396.SH"</span>, <span class="st">"688561.SH"</span>, <span class="st">"000001.SZ"</span>, <span class="st">"000002.SZ"</span>,</span>
<span id="cb50-35"><a href="#cb50-35" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000063.SZ"</span>, <span class="st">"000066.SZ"</span>, <span class="st">"000069.SZ"</span>, <span class="st">"000100.SZ"</span>, <span class="st">"000157.SZ"</span>, <span class="st">"000166.SZ"</span>,</span>
<span id="cb50-36"><a href="#cb50-36" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000333.SZ"</span>, <span class="st">"000338.SZ"</span>, <span class="st">"000425.SZ"</span>, <span class="st">"000538.SZ"</span>, <span class="st">"000568.SZ"</span>, <span class="st">"000596.SZ"</span>,</span>
<span id="cb50-37"><a href="#cb50-37" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000625.SZ"</span>, <span class="st">"000627.SZ"</span>, <span class="st">"000651.SZ"</span>, <span class="st">"000656.SZ"</span>, <span class="st">"000661.SZ"</span>, <span class="st">"000671.SZ"</span>,</span>
<span id="cb50-38"><a href="#cb50-38" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000703.SZ"</span>, <span class="st">"000708.SZ"</span>, <span class="st">"000709.SZ"</span>, <span class="st">"000723.SZ"</span>, <span class="st">"000725.SZ"</span>, <span class="st">"000728.SZ"</span>,</span>
<span id="cb50-39"><a href="#cb50-39" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000738.SZ"</span>, <span class="st">"000768.SZ"</span>, <span class="st">"000776.SZ"</span>, <span class="st">"000783.SZ"</span>, <span class="st">"000786.SZ"</span>, <span class="st">"000858.SZ"</span>,</span>
<span id="cb50-40"><a href="#cb50-40" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000860.SZ"</span>, <span class="st">"000876.SZ"</span>, <span class="st">"000895.SZ"</span>, <span class="st">"000938.SZ"</span>, <span class="st">"000959.SZ"</span>, <span class="st">"000961.SZ"</span>,</span>
<span id="cb50-41"><a href="#cb50-41" aria-hidden="true" tabindex="-1"></a>  <span class="st">"000963.SZ"</span>, <span class="st">"000977.SZ"</span>, <span class="st">"001979.SZ"</span>, <span class="st">"002001.SZ"</span>, <span class="st">"002007.SZ"</span>, <span class="st">"002008.SZ"</span>,</span>
<span id="cb50-42"><a href="#cb50-42" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002024.SZ"</span>, <span class="st">"002027.SZ"</span>, <span class="st">"002032.SZ"</span>, <span class="st">"002044.SZ"</span>, <span class="st">"002049.SZ"</span>, <span class="st">"002050.SZ"</span>,</span>
<span id="cb50-43"><a href="#cb50-43" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002120.SZ"</span>, <span class="st">"002142.SZ"</span>, <span class="st">"002146.SZ"</span>, <span class="st">"002153.SZ"</span>, <span class="st">"002179.SZ"</span>, <span class="st">"002202.SZ"</span>,</span>
<span id="cb50-44"><a href="#cb50-44" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002230.SZ"</span>, <span class="st">"002236.SZ"</span>, <span class="st">"002241.SZ"</span>, <span class="st">"002252.SZ"</span>, <span class="st">"002271.SZ"</span>, <span class="st">"002304.SZ"</span>,</span>
<span id="cb50-45"><a href="#cb50-45" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002311.SZ"</span>, <span class="st">"002352.SZ"</span>, <span class="st">"002371.SZ"</span>, <span class="st">"002410.SZ"</span>, <span class="st">"002415.SZ"</span>, <span class="st">"002422.SZ"</span>,</span>
<span id="cb50-46"><a href="#cb50-46" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002456.SZ"</span>, <span class="st">"002460.SZ"</span>, <span class="st">"002466.SZ"</span>, <span class="st">"002475.SZ"</span>, <span class="st">"002493.SZ"</span>, <span class="st">"002555.SZ"</span>,</span>
<span id="cb50-47"><a href="#cb50-47" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002594.SZ"</span>, <span class="st">"002601.SZ"</span>, <span class="st">"002602.SZ"</span>, <span class="st">"002607.SZ"</span>, <span class="st">"002624.SZ"</span>, <span class="st">"002648.SZ"</span>,</span>
<span id="cb50-48"><a href="#cb50-48" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002714.SZ"</span>, <span class="st">"002736.SZ"</span>, <span class="st">"002739.SZ"</span>, <span class="st">"002812.SZ"</span>, <span class="st">"002821.SZ"</span>, <span class="st">"002831.SZ"</span>,</span>
<span id="cb50-49"><a href="#cb50-49" aria-hidden="true" tabindex="-1"></a>  <span class="st">"002841.SZ"</span>, <span class="st">"002916.SZ"</span>, <span class="st">"002938.SZ"</span>, <span class="st">"002939.SZ"</span>, <span class="st">"002945.SZ"</span>, <span class="st">"002958.SZ"</span>,</span>
<span id="cb50-50"><a href="#cb50-50" aria-hidden="true" tabindex="-1"></a>  <span class="st">"003816.SZ"</span>, <span class="st">"300003.SZ"</span>, <span class="st">"300014.SZ"</span>, <span class="st">"300015.SZ"</span>, <span class="st">"300033.SZ"</span>, <span class="st">"300059.SZ"</span>,</span>
<span id="cb50-51"><a href="#cb50-51" aria-hidden="true" tabindex="-1"></a>  <span class="st">"300122.SZ"</span>, <span class="st">"300124.SZ"</span>, <span class="st">"300136.SZ"</span>, <span class="st">"300142.SZ"</span>, <span class="st">"300144.SZ"</span>, <span class="st">"300347.SZ"</span>,</span>
<span id="cb50-52"><a href="#cb50-52" aria-hidden="true" tabindex="-1"></a>  <span class="st">"300408.SZ"</span>, <span class="st">"300413.SZ"</span>, <span class="st">"300433.SZ"</span>, <span class="st">"300498.SZ"</span>, <span class="st">"300601.SZ"</span>, <span class="st">"300628.SZ"</span>,</span>
<span id="cb50-53"><a href="#cb50-53" aria-hidden="true" tabindex="-1"></a>  <span class="st">"300661.SZ"</span>, <span class="st">"300676.SZ"</span>, <span class="st">"300750.SZ"</span>, <span class="st">"300759.SZ"</span>, <span class="st">"300760.SZ"</span>, <span class="st">"300782.SZ"</span>,</span>
<span id="cb50-54"><a href="#cb50-54" aria-hidden="true" tabindex="-1"></a>  <span class="st">"300832.SZ"</span>, <span class="st">"300866.SZ"</span>, <span class="st">"300896.SZ"</span></span>
<span id="cb50-55"><a href="#cb50-55" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb50-56"><a href="#cb50-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-57"><a href="#cb50-57" aria-hidden="true" tabindex="-1"></a><span class="co"># 初始化一个列表来存储每支股票的数据</span></span>
<span id="cb50-58"><a href="#cb50-58" aria-hidden="true" tabindex="-1"></a>stock_data_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb50-59"><a href="#cb50-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-60"><a href="#cb50-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 获取每支股票的数据</span></span>
<span id="cb50-61"><a href="#cb50-61" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (symbol <span class="cf">in</span> hs300_stock_codes) {</span>
<span id="cb50-62"><a href="#cb50-62" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 获取股票数据</span></span>
<span id="cb50-63"><a href="#cb50-63" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> <span class="fu">md_stock</span>(symbol, <span class="at">date_range =</span> <span class="st">'5y'</span>, <span class="at">source =</span> <span class="st">"163"</span>, <span class="at">print_step =</span> <span class="dv">0</span>)</span>
<span id="cb50-64"><a href="#cb50-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb50-65"><a href="#cb50-65" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 将数据存储到列表中</span></span>
<span id="cb50-66"><a href="#cb50-66" aria-hidden="true" tabindex="-1"></a>  stock_data_list[[symbol]] <span class="ot">&lt;-</span> stock_data</span>
<span id="cb50-67"><a href="#cb50-67" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb50-68"><a href="#cb50-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb50-69"><a href="#cb50-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看第一支股票的数据</span></span>
<span id="cb50-70"><a href="#cb50-70" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(stock_data_list[[<span class="dv">1</span>]])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>$`600000.sh`
         symbol     name       date  open  high   low close volume    amount
         &lt;char&gt;   &lt;char&gt;     &lt;Date&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt; &lt;num&gt;  &lt;num&gt;     &lt;num&gt;
   1: 600000.SH 浦发银行 2020-03-09 11.00 11.00 10.75 10.78 594952 644379968
   2: 600000.SH 浦发银行 2020-03-10 10.71 10.96 10.70 10.87 447617 485896704
   3: 600000.SH 浦发银行 2020-03-11 10.93 10.93 10.77 10.77 316888 343734176
   4: 600000.SH 浦发银行 2020-03-12 10.75 10.75 10.61 10.64 326324 348157968
   5: 600000.SH 浦发银行 2020-03-13 10.40 10.73 10.28 10.70 574571 603756304
  ---                                                                       
1208: 600000.SH 浦发银行 2025-03-03 10.19 10.22 10.08 10.15 430109 436849850
1209: 600000.SH 浦发银行 2025-03-04 10.10 10.19 10.10 10.10 297698 301634439
1210: 600000.SH 浦发银行 2025-03-05 10.14 10.26 10.05 10.25 416864 424730036
1211: 600000.SH 浦发银行 2025-03-06 10.25 10.26 10.08 10.13 434994 441681584
1212: 600000.SH 浦发银行 2025-03-07 10.15 10.19 10.06 10.14 370059 374991809
      turnover close_adj
         &lt;num&gt;     &lt;num&gt;
   1:     0.21     90.87
   2:     0.16     91.47
   3:     0.11     90.81
   4:     0.12     89.95
   5:     0.20     90.34
  ---                   
1208:     0.15    100.78
1209:     0.10    100.45
1210:     0.14    101.43
1211:     0.15    100.64
1212:     0.13    100.71</code></pre>
</div>
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 初始化一个列表来存储每支股票的周度收益率</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>weekly_returns_list <span class="ot">&lt;-</span> <span class="fu">list</span>()</span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算每支股票的周度收益率</span></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (symbol <span class="cf">in</span> hs300_stock_codes) {</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 提取当前股票的数据</span></span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> stock_data_list[[symbol]][[<span class="dv">1</span>]]</span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 计算日度收益率</span></span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>  stock_data <span class="ot">&lt;-</span> stock_data <span class="sc">%&gt;%</span></span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">daily_return =</span> (close <span class="sc">-</span> <span class="fu">lag</span>(close)) <span class="sc">/</span> <span class="fu">lag</span>(close))</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 按周汇总日度收益率</span></span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>  weekly_returns <span class="ot">&lt;-</span> stock_data <span class="sc">%&gt;%</span></span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">week =</span> <span class="fu">floor_date</span>(date, <span class="st">"week"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(week) <span class="sc">%&gt;%</span></span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">weekly_return =</span> <span class="fu">mean</span>(daily_return, <span class="at">na.rm =</span> <span class="cn">TRUE</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>()</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>  <span class="co"># 将周度收益率存储到列表中</span></span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a>  weekly_returns_list[[symbol]] <span class="ot">&lt;-</span> weekly_returns</span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 合并所有股票的周度收益率</span></span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a>weekly_returns_df <span class="ot">&lt;-</span> <span class="fu">bind_rows</span>(weekly_returns_list, <span class="at">.id =</span> <span class="st">"symbol"</span>)</span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a><span class="co"># 将 weekly_returns_df 转换为宽格式</span></span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a>weekly_returns_wide <span class="ot">&lt;-</span> weekly_returns_df <span class="sc">%&gt;%</span></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_wider</span>(<span class="at">names_from =</span> symbol, <span class="at">values_from =</span> weekly_return)</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-31"><a href="#cb52-31" aria-hidden="true" tabindex="-1"></a><span class="co"># 移除包含缺失值的列</span></span>
<span id="cb52-32"><a href="#cb52-32" aria-hidden="true" tabindex="-1"></a>weekly_returns_wide <span class="ot">&lt;-</span> weekly_returns_wide <span class="sc">%&gt;%</span></span>
<span id="cb52-33"><a href="#cb52-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">where</span>(<span class="sc">~</span> <span class="fu">all</span>(<span class="sc">!</span><span class="fu">is.na</span>(.))))</span>
<span id="cb52-34"><a href="#cb52-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-35"><a href="#cb52-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 查看转换后的宽格式数据</span></span>
<span id="cb52-36"><a href="#cb52-36" aria-hidden="true" tabindex="-1"></a><span class="fu">head</span>(weekly_returns_wide)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6 × 273
  week       `600000.SH` `600004.SH` `600010.SH` `600011.SH` `600015.SH`
  &lt;date&gt;           &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;       &lt;dbl&gt;
1 2020-03-08   -0.00182    -0.0163    -0.00420     -0.00466   -0.00354  
2 2020-03-15   -0.0116     -0.0166    -0.00337     -0.0135    -0.0138   
3 2020-03-22    0.00308    -0.000420   0.000107     0.0100     0.00196  
4 2020-03-29   -0.00173    -0.00317   -0.00171     -0.0113    -0.00213  
5 2020-04-05    0.00150     0.00793    0.0000569    0.000601   0.0000307
6 2020-04-12   -0.000161    0.0116     0.0000460   -0.00408    0.000325 
# ℹ 267 more variables: `600016.SH` &lt;dbl&gt;, `600018.SH` &lt;dbl&gt;,
#   `600019.SH` &lt;dbl&gt;, `600025.SH` &lt;dbl&gt;, `600028.SH` &lt;dbl&gt;, `600029.SH` &lt;dbl&gt;,
#   `600030.SH` &lt;dbl&gt;, `600031.SH` &lt;dbl&gt;, `600036.SH` &lt;dbl&gt;, `600048.SH` &lt;dbl&gt;,
#   `600050.SH` &lt;dbl&gt;, `600104.SH` &lt;dbl&gt;, `600111.SH` &lt;dbl&gt;, `600115.SH` &lt;dbl&gt;,
#   `600118.SH` &lt;dbl&gt;, `600170.SH` &lt;dbl&gt;, `600177.SH` &lt;dbl&gt;, `600183.SH` &lt;dbl&gt;,
#   `600188.SH` &lt;dbl&gt;, `600196.SH` &lt;dbl&gt;, `600208.SH` &lt;dbl&gt;, `600219.SH` &lt;dbl&gt;,
#   `600221.SH` &lt;dbl&gt;, `600233.SH` &lt;dbl&gt;, `600271.SH` &lt;dbl&gt;, …</code></pre>
</div>
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a>stock_returns <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(<span class="fu">select</span>(weekly_returns_wide,<span class="sc">-</span>week))</span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a><span class="co"># 使用 cvCovEst 包进行协方差矩阵估计</span></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 线性收缩估计 (Ledoit-Wolf)</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>linear_shrink_est <span class="ot">&lt;-</span> <span class="fu">linearShrinkLWEst</span>(stock_returns)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 非线性收缩估计 (Ledoit-Wolf)</span></span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>nonlinear_shrink_est <span class="ot">&lt;-</span> <span class="fu">nlShrinkLWEst</span>(stock_returns)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 报告结果</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"线性收缩估计的协方差矩阵（前5行5列）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>线性收缩估计的协方差矩阵（前5行5列）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(linear_shrink_est[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             600000.SH    600004.SH    600010.SH    600011.SH    600015.SH
600000.SH 7.794016e-05 1.934616e-05 1.356862e-05 1.332348e-05 2.009596e-05
600004.SH 1.934616e-05 1.511077e-04 2.650557e-05 9.510637e-06 1.949519e-05
600010.SH 1.356862e-05 2.650557e-05 1.983571e-04 5.298162e-05 1.905860e-05
600011.SH 1.332348e-05 9.510637e-06 5.298162e-05 2.330116e-04 1.818018e-05
600015.SH 2.009596e-05 1.949519e-05 1.905860e-05 1.818018e-05 8.494534e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">非线性收缩估计的协方差矩阵（前5行5列）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
非线性收缩估计的协方差矩阵（前5行5列）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb60"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(nonlinear_shrink_est[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             [,1]         [,2]         [,3]         [,4]         [,5]
[1,] 6.949522e-05 3.309067e-07 3.879734e-07 2.144349e-07 1.891375e-07
[2,] 3.309067e-07 7.004062e-05 8.224714e-07 4.545841e-07 4.009558e-07
[3,] 3.879734e-07 8.224714e-07 7.030344e-05 5.329796e-07 4.701028e-07
[4,] 2.144349e-07 4.545841e-07 5.329796e-07 6.963371e-05 2.598282e-07
[5,] 1.891375e-07 4.009558e-07 4.701028e-07 2.598282e-07 6.956830e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb62"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 计算两种方法的差异</span></span>
<span id="cb62-2"><a href="#cb62-2" aria-hidden="true" tabindex="-1"></a>diff_matrix <span class="ot">&lt;-</span> linear_shrink_est <span class="sc">-</span> nonlinear_shrink_est</span>
<span id="cb62-3"><a href="#cb62-3" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">线性收缩与非线性收缩估计的差异矩阵（前5行5列）：</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>
线性收缩与非线性收缩估计的差异矩阵（前5行5列）：</code></pre>
</div>
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a><span class="fu">print</span>(diff_matrix[<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>])</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>             600000.SH    600004.SH    600010.SH    600011.SH    600015.SH
600000.SH 8.444939e-06 1.901526e-05 1.318065e-05 1.310905e-05 1.990682e-05
600004.SH 1.901526e-05 8.106710e-05 2.568310e-05 9.056053e-06 1.909423e-05
600010.SH 1.318065e-05 2.568310e-05 1.280537e-04 5.244864e-05 1.858850e-05
600011.SH 1.310905e-05 9.056053e-06 5.244864e-05 1.633778e-04 1.792035e-05
600015.SH 1.990682e-05 1.909423e-05 1.858850e-05 1.792035e-05 1.537703e-05</code></pre>
</div>
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 可视化协方差矩阵</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(Matrix)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">Matrix</span>(<span class="fu">cov2cor</span>(linear_shrink_est)), <span class="at">title =</span> <span class="st">"线性收缩估计的相关矩阵"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-6-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" aria-hidden="true" tabindex="-1"></a><span class="fu">image</span>(<span class="fu">Matrix</span>(<span class="fu">cov2cor</span>(nonlinear_shrink_est)), <span class="at">title =</span> <span class="st">"非线性收缩估计的相关矩阵"</span>)</span></code><button title="复制到剪贴板" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="high_dim_cov_est_files/figure-html/unnamed-chunk-6-2.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "已复制");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "已复制");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>